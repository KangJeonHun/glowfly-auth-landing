<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Glowfly 인증</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      background: #0b1220;
      color: #e7eefc;
    }
    .wrap { max-width: 760px; margin: 32px auto; padding: 20px; }
    .card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 18px;
    }
    h1 { margin: 0 0 10px; font-size: 18px; }
    p { margin: 8px 0; line-height: 1.5; color: rgba(231,238,252,0.85); }
    .muted { color: rgba(231,238,252,0.60); font-size: 12px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    input {
      flex:1;
      min-width: 240px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color:#e7eefc;
    }
    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 0;
      cursor:pointer;
      background:#18b6c9;
      color:#001018;
      font-weight: 700;
    }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .ok { color: #6ee7b7; }
    .err { color: #fb7185; }
    code {
      background: rgba(0,0,0,0.25);
      padding: 2px 6px;
      border-radius: 6px;
      word-break: break-all;
    }
    a { color: #7dd3fc; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="title">처리 중...</h1>
      <p id="desc" class="muted">브라우저에서 인증 정보를 확인하는 중입니다.</p>

      <div id="resetBox" style="display:none; margin-top:14px;">
        <p>새 비밀번호를 입력하세요.</p>
        <div class="row">
          <input id="pw1" type="password" placeholder="새 비밀번호" />
          <input id="pw2" type="password" placeholder="새 비밀번호 확인" />
        </div>
        <div style="margin-top:10px;">
          <button id="btnReset">비밀번호 변경</button>
        </div>
        <p id="msg" class="muted"></p>
      </div>

      <p id="status" style="margin-top:12px;"></p>

      <p class="muted" style="margin-top:16px;">
        Project: <code>xiecvrftlfrcsoveegip</code>
      </p>
    </div>
  </div>

<script>
(() => {
  // Project fixed values
  const SUPABASE_URL = "https://xiecvrftlfrcsoveegip.supabase.co";
  const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhpZWN2cmZ0bGZyY3NvdmVlZ2lwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNDM2MTYsImV4cCI6MjA4MzYxOTYxNn0.8BoVJJ-75ywfDCNPQDHSUu9wkhlLVRkvJsh0lZR2j84";

  const title = document.getElementById('title');
  const desc  = document.getElementById('desc');
  const status = document.getElementById('status');
  const resetBox = document.getElementById('resetBox');
  const msg = document.getElementById('msg');
  const btnReset = document.getElementById('btnReset');

  const hash = window.location.hash.startsWith('#') ? window.location.hash.slice(1) : window.location.hash;
  const params = new URLSearchParams(hash);

  // Error parameters may appear in hash
  const err = params.get('error') || params.get('error_description') || params.get('error_code');
  if (err) {
    title.textContent = '오류가 발생했습니다';
    desc.textContent = '인증 처리 중 문제가 발생했습니다.';
    status.className = 'err';
    status.textContent = String(params.get('error_description') || err);
    return;
  }

  const access_token = params.get('access_token') || '';
  const type = (params.get('type') || '').toLowerCase();
  const isRecovery = (type === 'recovery');

  // Reduce token leakage (remove fragment from the address bar)
  try {
    if (window.location.hash) {
      history.replaceState(null, document.title, window.location.pathname + window.location.search);
    }
  } catch (e) {}

  if (!access_token) {
    // Email confirmation often ends up here without access_token
    title.textContent = '이메일 인증 완료';
    desc.textContent = '창을 닫고 앱에서 로그인하면 됩니다.';
    status.className = 'ok';
    status.textContent = '완료';
    return;
  }

  if (!isRecovery) {
    title.textContent = '처리 완료';
    desc.textContent = '창을 닫고 앱에서 로그인하면 됩니다.';
    status.className = 'ok';
    status.textContent = '완료';
    return;
  }

  // Recovery flow: allow user to set new password
  title.textContent = '비밀번호 재설정';
  desc.textContent = '새 비밀번호를 설정하세요.';
  resetBox.style.display = 'block';

  btnReset.addEventListener('click', async () => {
    const pw1 = document.getElementById('pw1').value || '';
    const pw2 = document.getElementById('pw2').value || '';
    msg.className = 'muted';

    if (pw1.length < 8) {
      msg.textContent = '비밀번호는 8자 이상을 권장합니다.';
      return;
    }
    if (pw1 !== pw2) {
      msg.textContent = '비밀번호 확인이 일치하지 않습니다.';
      return;
    }

    btnReset.disabled = true;
    msg.textContent = '변경 중...';

    try {
      const res = await fetch(SUPABASE_URL + '/auth/v1/user', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'apikey': ANON_KEY,
          'Authorization': 'Bearer ' + access_token
        },
        body: JSON.stringify({ password: pw1 })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data?.msg || data?.error_description || data?.error || ('HTTP ' + res.status));
      }

      msg.className = 'ok';
      msg.textContent = '비밀번호 변경 완료. 창을 닫고 앱에서 새 비밀번호로 로그인하세요.';
    } catch (e) {
      msg.className = 'err';
      msg.textContent = '실패: ' + String(e?.message || e);
    } finally {
      btnReset.disabled = false;
    }
  });
})();
</script>
</body>
</html>
